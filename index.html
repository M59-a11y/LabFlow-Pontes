<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Marcos Pontes — Gestão Laboratorial</title>
  <link rel="manifest" href="manifest.json">
  <meta name="theme-color" content="#0f172a">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@400;500;600;700&family=DM+Mono:wght@500&display=swap" rel="stylesheet">
  <style>
    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

    :root {
      --bg: #0f172a;
      --surface: #1e293b;
      --surface2: #334155;
      --border: #334155;
      --text: #f1f5f9;
      --muted: #94a3b8;
      --sus: #22c55e;
      --sesc: #3b82f6;
      --accent: #f59e0b;
      --danger: #ef4444;
      --radius: 12px;
    }

    body {
      font-family: 'DM Sans', system-ui, sans-serif;
      background: var(--bg);
      color: var(--text);
      min-height: 100vh;
      padding: 32px 20px;
    }

    /* ── SCREEN HEADER ── */
    .screen-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 24px;
      max-width: 1280px;
      margin-inline: auto;
    }
    .brand { display: flex; align-items: center; gap: 14px; }
    .brand img { height: 52px; }
    .brand-text h1 { font-size: 1.25rem; font-weight: 700; letter-spacing: -.3px; }
    .brand-text p { font-size: .8rem; color: var(--muted); margin-top: 2px; }

    .month-picker {
      display: flex;
      align-items: center;
      gap: 10px;
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      padding: 8px 16px;
    }
    .month-picker label { font-size: .78rem; color: var(--muted); font-weight: 500; white-space: nowrap; }
    .month-picker input[type="month"] {
      background: transparent;
      border: none;
      color: var(--text);
      font-family: 'DM Mono', monospace;
      font-size: .9rem;
      font-weight: 500;
      outline: none;
      cursor: pointer;
      color-scheme: dark;
    }

    /* ── MAIN CARD ── */
    .card {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 16px;
      max-width: 1280px;
      margin-inline: auto;
      padding: 24px 28px;
    }

    /* ── SECTION LABEL ── */
    .section-label {
      display: flex;
      align-items: center;
      gap: 8px;
      margin-bottom: 6px;
      margin-top: 18px;
    }
    .section-label:first-of-type { margin-top: 0; }
    .dot { width: 9px; height: 9px; border-radius: 50%; flex-shrink: 0; }
    .dot-sus { background: var(--sus); box-shadow: 0 0 6px var(--sus); }
    .dot-sesc { background: var(--sesc); box-shadow: 0 0 6px var(--sesc); }
    .section-label span { font-weight: 600; font-size: .78rem; letter-spacing: .8px; text-transform: uppercase; color: var(--muted); }

    /* ── TABLE ── */
    .table-wrapper { overflow-x: auto; border-radius: 8px; border: 1px solid var(--border); }
    table { width: 100%; min-width: 700px; border-collapse: collapse; }
    thead tr { background: var(--surface2); }
    th {
      font-size: 9px; font-weight: 600; padding: 5px 2px;
      text-align: center; color: var(--muted);
      border-right: 1px solid var(--border);
    }
    th:last-child { border-right: none; }
    th.sus-th { color: var(--sus); }
    th.sesc-th { color: var(--sesc); }
    tbody tr td {
      border-right: 1px solid var(--border);
      border-top: 1px solid var(--border);
      padding: 0;
    }
    tbody tr td:last-child { border-right: none; }
    input[type="number"] {
      width: 100%; border: none; background: transparent;
      color: var(--text); text-align: center;
      font-size: 11px; font-family: 'DM Mono', monospace;
      padding: 6px 2px; -moz-appearance: textfield;
    }
    input[type="number"]::-webkit-inner-spin-button,
    input[type="number"]::-webkit-outer-spin-button { -webkit-appearance: none; }
    input[type="number"]:focus { outline: none; background: rgba(59,130,246,.15); color: #93c5fd; }
    input.sus:focus { background: rgba(34,197,94,.12); color: #86efac; }

    /* ── BOTTOM GRID ── */
    .bottom-row {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 16px;
      margin-top: 20px;
    }

    /* ── SUMMARY ── */
    .summary {
      background: var(--bg);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      padding: 18px 22px;
    }
    .summary-row {
      display: flex; justify-content: space-between; align-items: center;
      padding: 7px 0; border-bottom: 1px solid var(--border); font-size: .88rem;
    }
    .summary-row:last-child { border-bottom: none; }
    .summary-row .lbl { color: var(--muted); font-weight: 500; }
    .summary-row .val { font-family: 'DM Mono', monospace; font-weight: 600; }
    .val-sus { color: var(--sus); }
    .val-sesc { color: var(--sesc); }
    .summary-final {
      margin-top: 10px;
      background: linear-gradient(135deg, #1e3a5f 0%, #14532d 100%);
      border-radius: 10px; padding: 14px 18px;
      display: flex; justify-content: space-between; align-items: center;
    }
    .summary-final .fl { font-size: .72rem; color: #94a3b8; text-transform: uppercase; letter-spacing: 1px; }
    .summary-final .fv { font-size: 1.45rem; font-weight: 700; color: var(--accent); font-family: 'DM Mono', monospace; }

    /* ── CHART ── */
    .chart-wrap {
      background: var(--bg);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      padding: 18px 22px;
      display: flex; flex-direction: column;
    }
    .chart-wrap h3 { font-size: .72rem; color: var(--muted); text-transform: uppercase; letter-spacing: 1px; margin-bottom: 10px; }
    .chart-canvas-wrap { flex: 1; min-height: 100px; }

    /* ── BUTTONS ── */
    .btn-group {
      display: flex; gap: 10px; justify-content: flex-end;
      margin-top: 16px; max-width: 1280px;
      margin-inline: auto; flex-wrap: wrap;
    }
    button {
      display: flex; align-items: center; gap: 7px;
      padding: 10px 20px; border-radius: 10px; border: none;
      font-family: 'DM Sans', sans-serif; font-size: .85rem;
      font-weight: 600; cursor: pointer;
      transition: opacity .15s, transform .1s;
    }
    button:hover { opacity: .85; transform: translateY(-1px); }
    button:active { transform: translateY(0); }
    .btn-print { background: var(--sesc); color: #fff; }
    .btn-export { background: var(--surface2); color: var(--text); border: 1px solid var(--border); }
    .btn-danger { background: var(--danger); color: #fff; }

    /* ── PRINT ONLY ── */
    .print-only { display: none; }

    /* ══════════════════════════════════════
       PRINT
    ══════════════════════════════════════ */
    @media print {
      @page { size: A4 landscape; margin: 1.2cm; }

      html, body {
        background: #fff !important;
        color: #000 !important;
        font-family: 'DM Sans', sans-serif;
        -webkit-print-color-adjust: exact;
        print-color-adjust: exact;
        padding: 0 !important;
      }

      .screen-header,
      .btn-group { display: none !important; }

      .print-only { display: block !important; }

      /* reset card */
      .card {
        background: #fff !important;
        border: none !important;
        border-radius: 0 !important;
        padding: 0 !important;
        max-width: 100% !important;
      }

      /* ── print header ── */
      .print-header {
        display: flex !important;
        align-items: center;
        justify-content: space-between;
        padding-bottom: 8px;
        margin-bottom: 10px;
        border-bottom: 2px solid #000;
      }
      .ph-left h1 { font-size: 13px; font-weight: 700; color: #000; }
      .ph-left p { font-size: 9px; color: #555; margin-top: 2px; }
      .ph-right { text-align: right; font-size: 9px; color: #555; }
      .ph-right strong { display: block; font-size: 11px; color: #000; }

      /* section labels */
      .section-label { margin-top: 7px; margin-bottom: 3px; }
      .dot { width: 7px; height: 7px; box-shadow: none !important; }
      .dot-sus { background: #16a34a !important; }
      .dot-sesc { background: #1d4ed8 !important; }
      .section-label span { font-size: 7px; color: #444; }

      /* tables */
      .table-wrapper { border: 1px solid #bbb; border-radius: 4px; overflow: hidden; }
      table { min-width: unset !important; }
      th {
        background: #f3f4f6 !important;
        font-size: 7px; padding: 3px 1px;
        border-right: 1px solid #ddd;
        color: #666 !important;
      }
      th.sus-th { color: #15803d !important; }
      th.sesc-th { color: #1e40af !important; }
      tbody tr td { border-right: 1px solid #ddd; border-top: 1px solid #ddd; }
      input[type="number"] {
        color: #000 !important;
        font-size: 9px !important;
        padding: 3px 1px !important;
        background: transparent !important;
      }

      /* bottom grid */
      .bottom-row {
        display: grid !important;
        grid-template-columns: 1fr 1fr !important;
        gap: 10px !important;
        margin-top: 8px !important;
      }

      .summary {
        background: #f8fafc !important;
        border: 1px solid #ddd !important;
        border-radius: 6px !important;
        padding: 8px 12px !important;
      }
      .summary-row { padding: 4px 0; font-size: 9px; border-bottom: 1px solid #eee; }
      .summary-row .lbl { color: #666 !important; }
      .summary-row .val { color: #000 !important; }
      .val-sus { color: #15803d !important; }
      .val-sesc { color: #1e40af !important; }
      .summary-final {
        background: #f0fdf4 !important;
        border: 1px solid #bbf7d0 !important;
        border-radius: 6px !important;
        padding: 7px 12px !important;
        margin-top: 6px !important;
      }
      .summary-final .fl { font-size: 7px; color: #555 !important; }
      .summary-final .fv { font-size: 15px !important; color: #15803d !important; }

      .chart-wrap {
        background: #f8fafc !important;
        border: 1px solid #ddd !important;
        border-radius: 6px !important;
        padding: 8px 12px !important;
      }
      .chart-wrap h3 { font-size: 7px; color: #666 !important; margin-bottom: 4px; }
      .chart-canvas-wrap { min-height: 80px; }

      /* ── SIGNATURE — always below chart, right aligned ── */
      .print-footer {
        display: flex !important;
        justify-content: center;
        margin-top: 28px;
        page-break-inside: avoid;
        break-inside: avoid;
      }
      .sig-block { text-align: center; }
      .sig-date { font-size: 8px; color: #555; margin-bottom: 14px; }
      .sig-line { border-top: 1px solid #000; width: 220px; margin: 0 auto 4px; }
      .sig-name { font-size: 10px; font-weight: 700; }
      .sig-role { font-size: 8px; color: #555; }
    }
  </style>
</head>
<body>

  <!-- SCREEN HEADER -->
  <header class="screen-header">
    <div class="brand">
      <img src="logo.png" onerror="this.style.display='none'" alt="Logo">
      <div class="brand-text">
        <h1>Gestão Laboratorial</h1>
        <p>Produção Mensal — Marcos Pontes</p>
      </div>
    </div>
    <div class="month-picker">
      <label>Mês de referência</label>
      <input type="month" id="mesReferencia">
    </div>
  </header>

  <!-- MAIN CARD -->
  <div class="card">

    <!-- PRINT HEADER -->
    <div class="print-only print-header">
      <div class="ph-left">
        <h1>GESTÃO LABORATORIAL — Fechamento Mensal</h1>
        <p id="printSubtitle"></p>
      </div>

    </div>

    <!-- SUS -->
    <div class="section-label">
      <div class="dot dot-sus"></div>
      <span>SUS</span>
    </div>
    <div class="table-wrapper">
      <table><thead id="hSus"></thead><tbody id="bSus"></tbody></table>
    </div>

    <!-- SESC -->
    <div class="section-label" style="margin-top:16px">
      <div class="dot dot-sesc"></div>
      <span>SESC</span>
    </div>
    <div class="table-wrapper">
      <table><thead id="hSesc"></thead><tbody id="bSesc"></tbody></table>
    </div>

    <!-- BOTTOM -->
    <div class="bottom-row">
      <div class="summary">
        <div class="summary-row">
          <span class="lbl">SUS</span>
          <span class="val val-sus" id="txtSus">0</span>
        </div>
        <div class="summary-row">
          <span class="lbl">SESC</span>
          <span class="val val-sesc" id="txtSesc">0</span>
        </div>
        <div class="summary-row">
          <span class="lbl">Total de Exames</span>
          <span class="val" id="txtSoma">0</span>
        </div>
        <div class="summary-final">
          <span class="fl">Valor a Receber</span>
          <span class="fv" id="txtFinal">R$&nbsp;150,00</span>
        </div>
      </div>

      <div class="chart-wrap">
        <h3>Distribuição por Convênio</h3>
        <div class="chart-canvas-wrap">
          <canvas id="graficoBarras"></canvas>
        </div>
      </div>
    </div>

    <!-- PRINT FOOTER / SIGNATURE -->
    <div class="print-only print-footer">
      <div class="sig-block">
        <div class="sig-date" id="printDate"></div>
        <div class="sig-line"></div>
        <div class="sig-name">MARCOS PONTES</div>
        <div class="sig-role">Responsável Técnico</div>
      </div>
    </div>

  </div><!-- /card -->

  <!-- ACTION BUTTONS -->
  <div class="btn-group">
    <button class="btn-export" onclick="exportData()">
      <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.2"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>
      Exportar
    </button>
    <button class="btn-danger" onclick="limpar()">
      <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.2"><polyline points="3 6 5 6 21 6"/><path d="M19 6l-1 14H6L5 6"/><path d="M10 11v6"/><path d="M14 11v6"/></svg>
      Limpar
    </button>
    <button class="btn-print" onclick="window.print()">
      <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.2"><polyline points="6 9 6 2 18 2 18 9"/><path d="M6 18H4a2 2 0 0 1-2-2v-5a2 2 0 0 1 2-2h16a2 2 0 0 1 2 2v5a2 2 0 0 1-2 2h-2"/><rect x="6" y="14" width="12" height="8"/></svg>
      Imprimir
    </button>
  </div>

  <script>
    let chart;

    function getDaysInMonth(ym) {
      const [y, m] = ym.split('-').map(Number);
      return new Date(y, m, 0).getDate();
    }

    function buildTable(hId, bId, cls) {
      const ym = document.getElementById('mesReferencia').value || new Date().toISOString().slice(0,7);
      const days = getDaysInMonth(ym);
      const thCls = cls === 'sus' ? 'sus-th' : 'sesc-th';
      let h = '<tr>', b = '<tr>';
      for (let i = 1; i <= days; i++) {
        h += `<th class="${thCls}">${i}</th>`;
        b += `<td><input type="number" min="0" value="0" class="${cls}" data-day="${i}" oninput="recalc()"></td>`;
      }
      document.getElementById(hId).innerHTML = h + '</tr>';
      document.getElementById(bId).innerHTML = b + '</tr>';
    }

    function setup() {
      const inp = document.getElementById('mesReferencia');
      inp.value = new Date().toISOString().slice(0,7);
      buildTable('hSus','bSus','sus');
      buildTable('hSesc','bSesc','sesc');

      chart = new Chart(document.getElementById('graficoBarras'), {
        type: 'bar',
        data: {
          labels: ['SUS','SESC'],
          datasets: [{
            data: [0,0],
            backgroundColor: ['rgba(34,197,94,.7)','rgba(59,130,246,.7)'],
            borderColor: ['#22c55e','#3b82f6'],
            borderWidth: 1,
            borderRadius: 6,
            borderSkipped: false
          }]
        },
        options: {
          indexAxis: 'y',
          responsive: true,
          maintainAspectRatio: false,
          plugins: { legend: { display: false } },
          scales: {
            x: {
              beginAtZero: true,
              ticks: { precision: 0, color: '#94a3b8', font: { size: 10 } },
              grid: { color: 'rgba(148,163,184,.15)' }
            },
            y: {
              ticks: { color: '#94a3b8', font: { size: 11, weight: '600' } },
              grid: { display: false }
            }
          }
        }
      });

      inp.addEventListener('change', () => {
        buildTable('hSus','bSus','sus');
        buildTable('hSesc','bSesc','sesc');
        load();
      });

      load();
      document.getElementById('printDate').textContent =
        new Date().toLocaleDateString('pt-BR', { day:'2-digit', month:'long', year:'numeric' });
    }

    function recalc() {
      let s = 0, e = 0;
      document.querySelectorAll('.sus').forEach(i => s += +i.value || 0);
      document.querySelectorAll('.sesc').forEach(i => e += +i.value || 0);
      document.getElementById('txtSus').textContent = s;
      document.getElementById('txtSesc').textContent = e;
      document.getElementById('txtSoma').textContent = s + e;
      document.getElementById('txtFinal').textContent =
        ((s + e) * 1.0 + 150).toLocaleString('pt-BR', { style:'currency', currency:'BRL' });
      if (chart) { chart.data.datasets[0].data = [s,e]; chart.update(); }
      save();
    }

    function getValues(cls) {
      const v = {};
      document.querySelectorAll('.'+cls).forEach(i => v[i.dataset.day] = +i.value || 0);
      return v;
    }

    function save() {
      const mes = document.getElementById('mesReferencia').value;
      if (!mes) return;
      localStorage.setItem('lab_'+mes, JSON.stringify({ sus: getValues('sus'), sesc: getValues('sesc') }));
    }

    function load() {
      const mes = document.getElementById('mesReferencia').value;
      if (!mes) return;
      const label = new Date(mes+'-02').toLocaleDateString('pt-BR',{month:'long',year:'numeric'}).toUpperCase();
      const sub = document.getElementById('printSubtitle');
      if (sub) sub.textContent = label;
      const raw = localStorage.getItem('lab_'+mes);
      if (raw) {
        try {
          const d = JSON.parse(raw);
          document.querySelectorAll('.sus').forEach(i => i.value = d.sus?.[i.dataset.day] ?? 0);
          document.querySelectorAll('.sesc').forEach(i => i.value = d.sesc?.[i.dataset.day] ?? 0);
        } catch(e) {}
      }
      recalc();
    }

    function limpar() {
      if (!confirm('Limpar todos os dados do mês atual?')) return;
      document.querySelectorAll('input[type="number"]').forEach(i => i.value = 0);
      recalc();
    }

    function exportData() {
      const mes = document.getElementById('mesReferencia').value;
      const d = localStorage.getItem('lab_'+mes);
      if (!d) { alert('Nenhum dado para exportar.'); return; }
      const a = Object.assign(document.createElement('a'), {
        href: URL.createObjectURL(new Blob([d],{type:'application/json'})),
        download: `laboratorio_${mes}.json`
      });
      a.click();
    }

    window.addEventListener('load', setup);
  </script>
</body>
</html>
